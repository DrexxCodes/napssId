<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile - NAPSS UNIZIK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #065f46 0%, #10b981 100%);
        }
        .profile-card {
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.2);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-spinner {
            display: inline-block;
            width: 16px; height: 16px;
            border: 2.5px solid rgba(255,255,255,0.4);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-50 min-h-screen">

    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-lg no-print">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">Student Profile</h1>
                    <p class="text-green-100 mt-1 text-sm">NAPSS UNIZIK Card Management</p>
                </div>
                <a href="index.html" class="bg-white text-green-700 px-4 py-2 rounded-lg font-semibold hover:bg-green-50 transition-all">
                    ← Back to List
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-green-500 border-t-transparent"></div>
            <p class="text-gray-600 mt-4">Loading profile...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden">
            <div class="bg-red-50 border-2 border-red-300 rounded-2xl p-8 text-center">
                <svg class="w-16 h-16 text-red-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <h2 class="text-2xl font-bold text-red-800 mb-2">Profile Not Found</h2>
                <p class="text-red-600 mb-4" id="errorMessage">Student not found in database</p>
                <a href="index.html" class="inline-block bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-all">
                    Return to Dashboard
                </a>
            </div>
        </div>

        <!-- Profile Content -->
        <div id="profileContent" class="hidden">
            <div class="max-w-5xl mx-auto">

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 mb-6 no-print">
                    <button onclick="window.print()"
                        class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                        </svg>
                        Print Profile
                    </button>

                    <!-- ONE-CLICK DOWNLOAD ASSETS BUTTON -->
                    <button id="downloadAssetsBtn" onclick="downloadAllAssets()"
                        class="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-700 active:scale-95 text-white font-bold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2 shadow-md">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download Assets
                    </button>
                </div>

                <!-- Main Profile Card -->
                <div class="bg-white rounded-2xl shadow-xl profile-card p-6 md:p-8 mb-6">
                    <!-- Profile Header -->
                    <div class="flex flex-col md:flex-row gap-6 mb-8 pb-8 border-b-2 border-gray-200">

                        <!-- Profile Image -->
                        <div class="flex-shrink-0">
                            <div class="w-32 h-32 md:w-40 md:h-40 bg-gray-200 rounded-xl overflow-hidden mx-auto md:mx-0">
                                <img id="profileImage" class="w-full h-full object-cover hidden" alt="Profile"/>
                                <div id="profileImagePlaceholder" class="w-full h-full flex items-center justify-center bg-gradient-to-br from-green-400 to-emerald-500">
                                    <svg class="w-20 h-20 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Profile Info -->
                        <div class="flex-1">
                            <div class="flex items-start gap-3 mb-3 flex-wrap">
                                <h2 id="studentName"
                                    class="text-3xl font-bold text-gray-800 cursor-pointer hover:bg-yellow-100 transition-colors px-2 py-1 rounded"
                                    onclick="copyToClipboard(this.textContent, 'Name')" title="Click to copy">Loading...</h2>
                                <span id="studentTypeBadge" class="mt-1.5 inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-extrabold bg-green-100 text-green-700 border border-green-300 hidden">
                                    <span id="studentTypeDot" class="w-2 h-2 rounded-full bg-green-500 inline-block"></span>
                                    <span id="studentTypeLabel">Regular</span>
                                </span>
                            </div>
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
                                    </svg>
                                    <span class="text-gray-600 font-semibold">Reg Number:</span>
                                    <span id="regNumber"
                                        class="ml-2 font-mono font-bold text-gray-800 cursor-pointer hover:bg-yellow-100 transition-colors px-2 py-1 rounded"
                                        onclick="copyToClipboard(this.textContent, 'Registration Number')" title="Click to copy">--</span>
                                </div>

                                <div class="flex items-center" id="phoneContainer">
                                    <svg class="w-5 h-5 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                    <span class="text-gray-600 font-semibold">Phone:</span>
                                    <span id="phoneNumber"
                                        class="ml-2 font-semibold text-gray-800 cursor-pointer hover:bg-yellow-100 transition-colors px-2 py-1 rounded"
                                <div class="space-y-3">
                                    <svg class="w-5 h-5 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="text-gray-600 font-semibold">Registered:</span>
                                    <span id="registrationDate" class="ml-2 text-gray-800">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- QR Codes Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Virtual ID QR -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 text-center border-2 border-blue-200">
                            <h3 class="text-xl font-bold text-blue-800 mb-4 flex items-center justify-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
                                </svg>
                                Virtual ID
                            </h3>
                            <div class="bg-white p-4 rounded-lg inline-block">
                                <div id="virtualIdQR" class="mx-auto"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-3">Scans to student profile URL</p>
                        </div>

                        <!-- Scannable ID QR -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 text-center border-2 border-green-200">
                            <h3 class="text-xl font-bold text-green-800 mb-4 flex items-center justify-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Scannable ID
                            </h3>
                            <div class="bg-white p-4 rounded-lg inline-block">
                                <div id="scannableIdQR" class="mx-auto"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-3" id="scannableUrl">--</p>
                        </div>
                    </div>
                </div>

                <!-- Profile Status Card -->
                <div class="bg-white rounded-xl shadow-lg p-6 no-print">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Profile Status</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="cloudStatus">--</div>
                            <div class="text-sm text-gray-600">Cloud Status</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="photoStatus">--</div>
                            <div class="text-sm text-gray-600">Photo Status</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600">Active</div>
                            <div class="text-sm text-gray-600">Account Status</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

<script>
// ═══════════════════════════════════════════════════════════════════
// FIREBASE
// ═══════════════════════════════════════════════════════════════════
const firebaseConfig = {
    apiKey: "AIzaSyDIiht0HgpOoEexwAcEFfCFRtb8WtTho0c",
    authDomain: "cobaltai-6c012.firebaseapp.com",
    projectId: "cobaltai-6c012",
    storageBucket: "cobaltai-6c012.firebasestorage.app",
    messagingSenderId: "703066241181",
    appId: "1:703066241181:web:2b995f41ed42b6ed1b7c74"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentStudent   = null;
let currentFirestore = null;

// ─── Helpers ─────────────────────────────────────────────────────
function getRegFromURL() {
    return new URLSearchParams(window.location.search).get('reg');
}

function isCepReg(reg) {
    return String(reg).startsWith('2025133');
}

// ─── Load from the correct JSON based on reg prefix ──────────────
async function loadLocalStudent(reg) {
    const sources = isCepReg(reg)
        ? ['../api/cep.json', '../api/data.json']   // try CEP first, fall back to regular
        : ['../api/data.json', '../api/cep.json'];  // try regular first, fall back to CEP

    for (const src of sources) {
        try {
            const res  = await fetch(src);
            if (!res.ok) continue;
            const list = await res.json();
            const found = list.find(s => s.reg_number === reg);
            if (found) {
                // Tag the source type
                found._type = src.includes('cep') ? 'cep' : 'regular';
                return found;
            }
        } catch { /* try next */ }
    }
    return null;
}

// ─── Load Firestore ───────────────────────────────────────────────
async function loadFirestore(reg) {
    try {
        const snap = await db.collection('enrollments').doc(reg).get();
        return snap.exists ? snap.data() : null;
    } catch { return null; }
}

// ─── Generate QR (display) ────────────────────────────────────────
function generateQRCode(containerId, text) {
    const el = document.getElementById(containerId);
    el.innerHTML = '';
    new QRCode(el, {
        text,
        width: 200, height: 200,
        colorDark: '#065f46', colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
    });
}

// ─── QR dataURL for download ──────────────────────────────────────
function makeQRDataURL(text, size) {
    return new Promise(resolve => {
        const div = document.createElement('div');
        div.style.cssText = 'position:fixed;left:-9999px;top:0;';
        document.body.appendChild(div);
        try {
            new QRCode(div, {
                text, width: size || 300, height: size || 300,
                colorDark: '#1a5c2e', colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
            setTimeout(() => {
                const el = div.querySelector('img') || div.querySelector('canvas');
                if (!el) { document.body.removeChild(div); return resolve(null); }
                const src = el.tagName === 'IMG' ? el.src : el.toDataURL();
                document.body.removeChild(div);
                resolve(src);
            }, 450);
        } catch(e) { document.body.removeChild(div); resolve(null); }
    });
}

// ─── Fetch image → dataURL ────────────────────────────────────────
async function fetchImageAsDataURL(url) {
    if (!url) return null;
    try {
        const res  = await fetch(url);
        const blob = await res.blob();
        return await new Promise((res, rej) => {
            const reader = new FileReader();
            reader.onload  = () => res(reader.result);
            reader.onerror = rej;
            reader.readAsDataURL(blob);
        });
    } catch {
        return new Promise(resolve => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                try {
                    const c = document.createElement('canvas');
                    c.width = img.width; c.height = img.height;
                    c.getContext('2d').drawImage(img, 0, 0);
                    resolve(c.toDataURL('image/jpeg', 0.92));
                } catch { resolve(null); }
            };
            img.onerror = () => resolve(null);
            img.src = url;
        });
    }
}

function dataURLtoUint8(dataURL) {
    const b64 = dataURL.split(',')[1];
    const bin = atob(b64);
    const arr = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
    return arr;
}

// ─── Metadata PDF (CEP-aware) ─────────────────────────────────────
function buildMetadataPDF(student) {
    const { jsPDF } = window.jspdf;
    const doc  = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a5' });
    const W    = doc.internal.pageSize.getWidth();
    const H    = doc.internal.pageSize.getHeight();
    const isCep = student._type === 'cep';

    const [r,g,b] = isCep ? [37,99,235] : [6,95,70];
    doc.setFillColor(r, g, b);
    doc.rect(0, 0, W, 30, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.text('NAPSS UNIZIK', W / 2, 13, { align: 'center' });
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7);
    doc.text('NATIONAL ASSOCIATION OF POLITICAL SCIENCE STUDENTS', W / 2, 20, { align: 'center' });
    doc.text(isCep ? 'CONTINUING EDUCATION PROGRAMME (CEP)' : 'NNAMDI AZIKIWE UNIVERSITY CHAPTER', W / 2, 26, { align: 'center' });

    let y = 46;
    function field(label, value) {
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(7.5);
        doc.setTextColor(...(isCep ? [37,99,235] : [6,95,70]));
        doc.text(label, 18, y);
        y += 6;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(12);
        doc.setTextColor(17, 24, 39);
        doc.text(String(value || '—'), 18, y);
        y += 3;
        doc.setDrawColor(229, 231, 235);
        doc.setLineWidth(0.3);
        doc.line(18, y, W - 18, y);
        y += 10;
    }

    field('FULL NAME',           student.full_name);
    field('REGISTRATION NUMBER', student.reg_number);
    field('PROGRAMME',           isCep ? 'Continuing Education Programme (CEP)' : 'Regular');
    field('PHONE NUMBER',        student.phoneNumber || '—');

    y += 4;
    doc.setFont('helvetica', 'italic');
    doc.setFontSize(8);
    doc.setTextColor(107, 114, 128);
    doc.text('Profile photo and QR codes are included separately in this folder.', 18, y, { maxWidth: W - 36 });

    const footerY = H - 14;
    doc.setFillColor(243, 244, 246);
    doc.rect(0, footerY - 5, W, 19, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8.5);
    doc.setTextColor(...(isCep ? [37,99,235] : [6,95,70]));
    doc.text('Developed by Drexx Technologies', W / 2, footerY + 3, { align: 'center' });
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(6.5);
    doc.setTextColor(156, 163, 175);
    doc.text('NAPSS UNIZIK Card Management System', W / 2, footerY + 9, { align: 'center' });

    return doc.output('arraybuffer');
}

// ═══════════════════════════════════════════════════════════════════
// ONE-CLICK DOWNLOAD ALL ASSETS
// ═══════════════════════════════════════════════════════════════════
async function downloadAllAssets() {
    if (!currentStudent) { alert('Student data not loaded yet.'); return; }

    const btn = document.getElementById('downloadAssetsBtn');
    btn.disabled = true;
    btn.innerHTML = `<span class="btn-spinner"></span> Preparing...`;

    try {
        const s = {
            ...currentStudent,
            phoneNumber: currentFirestore?.phoneNumber || null,
            profileURL:  currentFirestore?.profileURL  || null,
        };

        const zip = new JSZip();

        btn.innerHTML = `<span class="btn-spinner"></span> Generating QR codes...`;
        const virtualURL = `https://napss-nau.vercel.app/stu/${s.reg_number}`;
        const [vQR, sQR] = await Promise.all([makeQRDataURL(virtualURL, 300), makeQRDataURL(s.reg_number, 300)]);
        if (vQR) zip.file('virtual_qr.png',   dataURLtoUint8(vQR));
        if (sQR) zip.file('scannable_qr.png', dataURLtoUint8(sQR));

        if (s.profileURL) {
            btn.innerHTML = `<span class="btn-spinner"></span> Fetching photo...`;
            const imgDataURL = await fetchImageAsDataURL(s.profileURL);
            if (imgDataURL) {
                const mimeMatch = imgDataURL.match(/^data:(image\/[a-z+]+);base64,/);
                const ext = mimeMatch ? (mimeMatch[1] === 'image/png' ? 'png' : mimeMatch[1] === 'image/webp' ? 'webp' : 'jpg') : 'jpg';
                zip.file(`profile.${ext}`, dataURLtoUint8(imgDataURL));
            }
        }

        btn.innerHTML = `<span class="btn-spinner"></span> Building PDF...`;
        zip.file('profile.pdf', buildMetadataPDF(s));

        btn.innerHTML = `<span class="btn-spinner"></span> Compressing...`;
        const zipBlob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });

        const safeName = (s.full_name || 'student').replace(/[^a-zA-Z0-9 ]/g, '').trim().replace(/\s+/g, '_');
        const a = document.createElement('a');
        a.href     = URL.createObjectURL(zipBlob);
        a.download = `${s.reg_number}_${safeName}.zip`;
        a.click();
        URL.revokeObjectURL(a.href);
        showNotification('Assets downloaded successfully!');

    } catch(e) {
        console.error('Download error:', e);
        alert('Download failed: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
        </svg> Download Assets`;
    }
}

// ═══════════════════════════════════════════════════════════════════
// DISPLAY PROFILE  (CEP-aware)
// ═══════════════════════════════════════════════════════════════════
async function displayProfile(localData, firestoreData) {
    const isCep = localData._type === 'cep';

    // Name + type badge
    document.getElementById('studentName').textContent = localData.full_name;
    const badge = document.getElementById('studentTypeBadge');
    const dot   = document.getElementById('studentTypeDot');
    const lbl   = document.getElementById('studentTypeLabel');
    badge.classList.remove('hidden');
    if (isCep) {
        badge.className = badge.className.replace('bg-green-100 text-green-700 border-green-300','bg-blue-100 text-blue-700 border-blue-300');
        dot.className   = dot.className.replace('bg-green-500','bg-blue-500');
        lbl.textContent = 'CEP';
    } else {
        lbl.textContent = 'Regular';
    }

    document.getElementById('regNumber').textContent        = localData.reg_number;
    document.getElementById('registrationDate').textContent = localData.date;

    // Phone
    const phoneContainer = document.getElementById('phoneContainer');
    if (firestoreData?.phoneNumber) {
        document.getElementById('phoneNumber').textContent = firestoreData.phoneNumber;
    } else {
        phoneContainer.classList.add('hidden');
    }

    // Photo
    const profileImage            = document.getElementById('profileImage');
    const profileImagePlaceholder = document.getElementById('profileImagePlaceholder');
    if (firestoreData?.profileURL) {
        profileImage.src = firestoreData.profileURL;
        profileImage.classList.remove('hidden');
        profileImagePlaceholder.classList.add('hidden');
        document.getElementById('photoStatus').textContent = '✔ Uploaded';
    } else {
        document.getElementById('photoStatus').textContent = 'No Photo';
    }

    document.getElementById('cloudStatus').textContent = firestoreData ? '✔ Synced' : 'Local Only';

    // QR codes (display)
    generateQRCode('virtualIdQR',   `https://napss-nau.vercel.app/stu/${localData.reg_number}`);
    generateQRCode('scannableIdQR', localData.reg_number);
    document.getElementById('scannableUrl').textContent = localData.reg_number;

    // Colour-theme the profile status card header for CEP
    const statusCard = document.querySelector('#profileContent .bg-white.rounded-xl.shadow-lg');
    if (statusCard && isCep) {
        const h3 = statusCard.querySelector('h3');
        if (h3) h3.classList.add('text-blue-800');
    }

    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('profileContent').classList.remove('hidden');
}

function showError(msg) {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('errorMessage').textContent = msg;
    document.getElementById('errorState').classList.remove('hidden');
}

// ─── Clipboard ────────────────────────────────────────────────────
function copyToClipboard(text, field) {
    const copy = () => showNotification(field + ' copied!');
    if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text).then(copy).catch(() => fallbackCopy(text, field));
    } else { fallbackCopy(text, field); }
}
function fallbackCopy(text, field) {
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.cssText = 'position:fixed;left:-999999px';
    document.body.appendChild(ta); ta.select();
    try { document.execCommand('copy'); showNotification(field + ' copied!'); } catch {}
    document.body.removeChild(ta);
}
function showNotification(msg) {
    const n = document.createElement('div');
    n.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center animate-slideIn';
    n.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg><span>${msg}</span>`;
    document.body.appendChild(n);
    setTimeout(() => { n.style.opacity = '0'; n.style.transition = 'opacity 0.3s'; setTimeout(() => document.body.removeChild(n), 300); }, 2500);
}

window.copyToClipboard   = copyToClipboard;
window.downloadAllAssets = downloadAllAssets;

// ─── INIT ─────────────────────────────────────────────────────────
async function initProfile() {
    const reg = getRegFromURL();
    if (!reg) { showError('No registration number provided in URL'); return; }

    const localData = await loadLocalStudent(reg);
    if (!localData) {
        showError(`Student "${reg}" not found in either Regular or CEP database`);
        return;
    }

    currentStudent   = localData;
    currentFirestore = await loadFirestore(reg);

    await displayProfile(localData, currentFirestore);
}

document.addEventListener('DOMContentLoaded', initProfile);
</script>
    
</script>
</body>
</html>